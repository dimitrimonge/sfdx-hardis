 /*Pipeline for Salesforce using sfdx-hardis

 You need to do a CTRL+F on "MANUAL" and add your variable instead of example variable


 */
pipeline {
    agent any
    // MANUAL : Add Environment variable if necessary
    environment {
        SFDX_CLIENT_ID_INTEGRATION =  credentials('SFDX_CLIENT_ID_INTEGRATION') //Example
        SFDX_CLIENT_KEY_INTEGRATION =  credentials('SFDX_CLIENT_KEY_INTEGRATION') //Example
        SFDX_CLIENT_ID_UAT =  credentials('SFDX_CLIENT_ID_UAT') //Example
        SFDX_CLIENT_KEY_UAT =  credentials('SFDX_CLIENT_KEY_UAT') //Example
        SFDX_CLIENT_ID_PREPROD =  credentials('SFDX_CLIENT_ID_PREPROD') //Example
        SFDX_CLIENT_KEY_PREPROD =  credentials('SFDX_CLIENT_KEY_PREPROD') //Example
        SFDX_CLIENT_ID_MAIN =  credentials('SFDX_CLIENT_ID_MAIN') //Example
        SFDX_CLIENT_KEY_MAIN =  credentials('SFDX_CLIENT_KEY_MAIN') //Example
        CONFIG_BRANCH = "${GIT_BRANCH}"
        CI_COMMIT_REF_NAME = "${GIT_BRANCH}"
        ORG_ALIAS = "${GIT_BRANCH}"
    }

    //Stage of the job
    stages {
        parallel {
            //run megalinter
            stage('MegaLinter') {
                agent {
                    docker {
                        image 'oxsecurity/megalinter:v7'
                        args "-u root -e VALIDATE_ALL_CODEBASE=true -v ${WORKSPACE}:/tmp/lint --entrypoint=''"
                        reuseNode true
                    }
                }
                steps {
                    sh '/entrypoint.sh'
                }
                post {
                    always {
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'mega-linter.log,megalinter-reports/**/*', defaultExcludes: false, followSymlinks: false
                    }
                }
            }
            stage('Validation') {
                agent {
                    docker {
                        image 'hardisgroupcom/sfdx-hardis:latest'
                    }
                }
                when { changeRequest() }
                //Validation on the appropriate org
                steps {
                    script {
                        sh 'sfdx hardis:auth:login'
                        sh 'sfdx hardis:project:deploy:sources:dx --check'
                    }
                }
                post {
                    always {
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'hardis-report', defaultExcludes: false, followSymlinks: false
                    }
                }
            }
            stage('Deployment') {
                agent {
                    docker {
                        image 'hardisgroupcom/sfdx-hardis:latest'
                    }
                }
                //MANUAL: add your major branch if necessary
                when {
                    anyOf {
                            branch 'integration'; //Example
                            branch: 'uat'; //Example
                            branch: 'preprod'; //Example
                            branch 'main' //Example
                    }
                }
                //deploy on the appropriate org
                steps {
                    script {
                        sh 'sfdx hardis:auth:login'
                        sh 'sfdx hardis:project:deploy:sources:dx'
                    }
                }
                post {
                    always {
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'hardis-report', defaultExcludes: false, followSymlinks: false
                    }
                }
            }
        }
    }
}
